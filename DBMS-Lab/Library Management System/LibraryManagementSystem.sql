--Copyright (C) 2021 Kritik Agarwal <https://github.com/Kritik007>
--------------------------------------------------------------------------------------------------------------------------------
---- Consider the following schema for a Library Database:
---- BOOK (Book_id, Title, Publisher_Name, Pub_Year)
---- BOOK_AUTHORS (Book_id, Author_Name)
---- PUBLISHER (Name, Address, Phone)
---- BOOK_COPIES (Book_id, Branch_id, No-of_Copies)
---- BOOK_LENDING (Book_id, Branch_id, Card_No, Date_Out, Due_Date)
---- LIBRARY_BRANCH (Branch_id, Branch_Name, Address)

--------------------------------------------------------------------------------------------------------------------------------

------------------ START ----------------

-- CREATE DATABASE (RUN ONLY ONCE)
CREATE DATABASE [LibraryDB];
GO

--USING THE EXISTING DATABASE
USE [LibraryDB];
GO

--CREATING TABLES
--T1
CREATE TABLE [PUBLISHER] (
  [NAME] VARCHAR(50) NOT NULL PRIMARY KEY,
  [ADDRESS] VARCHAR(50) NOT NULL,
  [PHONE] VARCHAR(50),
);
GO

--T2
CREATE TABLE [BOOK] (
  [BOOK_ID] INT NOT NULL PRIMARY KEY,
  [TITLE] VARCHAR(100) NOT NULL,
  [PUBLISHER_NAME] VARCHAR(50) REFERENCES PUBLISHER([NAME])  ON DELETE CASCADE,
  [PUB_YEAR] VARCHAR(10) NOT NULL,
);
GO

--T3
CREATE TABLE [BOOK_AUTHORS] (
  [BOOK_ID] INT REFERENCES BOOK([BOOK_ID])  ON DELETE CASCADE,
  [AUTHOR_NAME] VARCHAR(50) NOT NULL,
  PRIMARY KEY ([BOOK_ID], [AUTHOR_NAME])
);
GO

--T4
CREATE TABLE [LIBRARY_BRANCH] (
  [BRANCH_ID] INT NOT NULL PRIMARY KEY,
  [BRANCH_NAME] VARCHAR(20) NOT NULL,
  [ADDRESS] VARCHAR(50) NOT NULL,
);
GO

--T5
CREATE TABLE [BOOK_COPIES] (
  [BOOK_ID] INT REFERENCES BOOK([BOOK_ID])  ON DELETE CASCADE,
  [BRANCH_ID] INT REFERENCES LIBRARY_BRANCH([BRANCH_ID])  ON DELETE CASCADE,
  [NO_OF_COPIES] INT,
  PRIMARY KEY ([BOOK_ID], [BRANCH_ID])
);
GO

--T6
CREATE TABLE [BOOK_LENDING] (
  [BOOK_ID] INT REFERENCES BOOK([BOOK_ID])  ON DELETE CASCADE,
  [BRANCH_ID] INT REFERENCES LIBRARY_BRANCH([BRANCH_ID])  ON DELETE CASCADE,
  [CARD_NO] INT NOT NULL,
  [DATE_OUT] DATE NOT NULL,
  [DUE_DATE] DATE NOT NULL,
  PRIMARY KEY ([BOOK_ID], [BRANCH_ID], [CARD_NO])
);
GO

--INSERTING SOME VALUES INTO THE DATABASE
--1
INSERT INTO PUBLISHER VALUES ('MCGRAW-HILL','BENGALURU', 9191919191);
INSERT INTO PUBLISHER VALUES ('PEARSON','CHENNAI', 8181818181);
INSERT INTO PUBLISHER VALUES ('PRENTICE HALL','DELHI', 7171717171);
INSERT INTO PUBLISHER VALUES ('PRINCETON UNIVERSITY PRESS','GUJARAT', 6161616161);
INSERT INTO PUBLISHER VALUES ('PLANETA','KOLKATA', 5151515151);
INSERT INTO PUBLISHER VALUES ('RANDOM HOUSE','HYDERABAD', 4141414141);
INSERT INTO PUBLISHER VALUES ('LIVRE','ORRISA', 3131313131);
GO

SELECT * FROM PUBLISHER;
GO

--2
INSERT INTO BOOK VALUES (101, 'JAVA: THE COMPLETE REFERENCE', 'MCGRAW-HILL', 2016);
INSERT INTO BOOK VALUES (102,'DATA VISUALIZATION: A PRACTICAL INTRODUCTION', 'PRINCETON UNIVERSITY PRESS', 2016);
INSERT INTO BOOK VALUES (103, 'MICROPROCESSOR ARCHITECTURE, PROGRAMMING & APPLICATIONS WITH THE 8085', 'PRENTICE HALL', 2002);
INSERT INTO BOOK VALUES (104, 'FORMAL LANGUAGES & AUTOMATA THEORY', 'PEARSON', 2016);
INSERT INTO BOOK VALUES (105, 'DATABASE MANAGEMENT SYSTEM', 'RANDOM HOUSE', 2014);
INSERT INTO BOOK VALUES (106, 'ADVANCED DATABASE MANAGEMENT SYSTEM', 'MCGRAW-HILL', 2016);
INSERT INTO BOOK VALUES (107, 'CYBERSECURITY', 'PLANETA', 2015);
INSERT INTO BOOK VALUES (108, 'OPERATING SYSTEM: A PRACTICAL APPROACH', 'PEARSON', 2015);
GO

SELECT * FROM BOOK;
GO

--3
INSERT INTO BOOK_AUTHORS VALUES (101, 'Herbert Schildt');
INSERT INTO BOOK_AUTHORS VALUES (102, 'Kieran Healy');
INSERT INTO BOOK_AUTHORS VALUES (103, 'Ramesh S. Gaonkar');
INSERT INTO BOOK_AUTHORS VALUES (104, 'K.V.N. Sunitha');
INSERT INTO BOOK_AUTHORS VALUES (105, 'NAVATHE');
INSERT INTO BOOK_AUTHORS VALUES (106, 'NAVATHE');
INSERT INTO BOOK_AUTHORS VALUES (107, 'MD FARHAN');
INSERT INTO BOOK_AUTHORS VALUES (108, 'KRITIK');
GO

SELECT * FROM BOOK_AUTHORS;
GO

--4
INSERT INTO LIBRARY_BRANCH VALUES (09,'CMRU-SOET', 'BENGALURU');
INSERT INTO LIBRARY_BRANCH VALUES (10,'RR NAGAR','BENGALURU');
INSERT INTO LIBRARY_BRANCH VALUES (11,'RNSIT','BENGALURU');
INSERT INTO LIBRARY_BRANCH VALUES (12,'RAJAJI NAGAR','BENGALURU');
INSERT INTO LIBRARY_BRANCH VALUES (13,'NITTE','MANGALORE');
INSERT INTO LIBRARY_BRANCH VALUES (14,'MANIPAL','UDUPI');
GO

SELECT * FROM LIBRARY_BRANCH;
GO

--5
INSERT INTO BOOK_COPIES VALUES (101, 09, 10);
INSERT INTO BOOK_COPIES VALUES (102, 09, 12);
INSERT INTO BOOK_COPIES VALUES (103, 10, 15);
INSERT INTO BOOK_COPIES VALUES (104, 11, 30);
INSERT INTO BOOK_COPIES VALUES (105, 12, 50);
INSERT INTO BOOK_COPIES VALUES (106, 13, 8);
INSERT INTO BOOK_COPIES VALUES (107, 14, 11);
INSERT INTO BOOK_COPIES VALUES (108, 10, 16);
GO

SELECT * FROM BOOK_COPIES;
GO

--6
INSERT INTO BOOK_LENDING VALUES (101, 13, 2294, '2017-05-21', '2017-06-03');
INSERT INTO BOOK_LENDING VALUES (102, 10, 2294, '2017-04-28', '2017-05-10');
INSERT INTO BOOK_LENDING VALUES (103, 09, 2486, '2017-03-30', '2017-04-12');
INSERT INTO BOOK_LENDING VALUES (104, 09, 2698, '2017-02-28', '2017-03-11');
INSERT INTO BOOK_LENDING VALUES (105, 13, 2698, '2017-05-21', '2017-06-03');
INSERT INTO BOOK_LENDING VALUES (106, 10, 2486, '2017-04-28', '2017-05-10');
INSERT INTO BOOK_LENDING VALUES (107, 09, 2294, '2017-03-30', '2017-04-12');
INSERT INTO BOOK_LENDING VALUES (108, 09, 2294, '2017-02-28', '2017-03-11');
GO

SELECT * FROM BOOK_LENDING;
GO

-- QUERIES

-- Q1 Retrieve details of all books in the library â€“ id, title, name of publisher, authors, number of copies in each branch, etc.
SELECT B.BOOK_ID, B.TITLE, B.PUBLISHER_NAME, A.AUTHOR_NAME,C.NO_OF_COPIES,L.BRANCH_ID 
FROM BOOK B, BOOK_AUTHORS A, BOOK_COPIES C, LIBRARY_BRANCH L 
WHERE B.BOOK_ID=A. BOOK_ID AND B.BOOK_ID=C.BOOK_ID AND L.BRANCH_ID=C.BRANCH_ID;
GO

-- Q2 Get the particulars of borrowers who have borrowed more than 3 books, but from Jan 2017 to Jun 2017
SELECT CARD_NO 
FROM BOOK_LENDING 
WHERE DATE_OUT BETWEEN '2017-01-01' AND '2017-06-30' 
GROUP BY CARD_NO HAVING COUNT(*)>3;
GO

-- Q3 Delete a book in BOOK table. Update the contents of other tables to reflect this data manipulation operation.
DELETE FROM BOOK WHERE BOOK_ID = 107;
SELECT * FROM BOOK;
GO

-- Q4 Partition the BOOK table based on year of publication. Demonstrate its working with a simple query.

----PARTITION FUNCTION
CREATE PARTITION FUNCTION PF_PUB_YEAR (VARCHAR(10)) AS RANGE RIGHT FOR VALUES (2021);

----PARTITION SCHEME
CREATE PARTITION SCHEME PS_PUB_YEAR AS PARTITION PF_PUB_YEAR ALL TO ([PRIMARY]);

----PARTITION TABLE
CREATE TABLE [BOOK_PART] (
  [BOOK_ID] INT REFERENCES BOOK([BOOK_ID]),
  [TITLE] VARCHAR(100) NOT NULL,
  [PUBLISHER_NAME] VARCHAR(50) REFERENCES PUBLISHER([NAME]),
  [PUB_YEAR] VARCHAR(10) NOT NULL,
) ON PS_PUB_YEAR(PUB_YEAR);
GO

INSERT INTO BOOK_PART VALUES (101, 'JAVA: THE COMPLETE REFERENCE', 'MCGRAW-HILL', 2016);
INSERT INTO BOOK_PART VALUES (102,'DATA VISUALIZATION: A PRACTICAL INTRODUCTION', 'PRINCETON UNIVERSITY PRESS', 2016);
INSERT INTO BOOK_PART VALUES (103, 'MICROPROCESSOR ARCHITECTURE, PROGRAMMING & APPLICATIONS WITH THE 8085', 'PRENTICE HALL', 2002);
INSERT INTO BOOK_PART VALUES (104, 'FORMAL LANGUAGES & AUTOMATA THEORY', 'PEARSON', 2016);
INSERT INTO BOOK_PART VALUES (105, 'DATABASE MANAGEMENT SYSTEM', 'RANDOM HOUSE', 2014);
INSERT INTO BOOK_PART VALUES (106, 'ADVANCED DATABASE MANAGEMENT SYSTEM', 'MCGRAW-HILL', 2016);
INSERT INTO BOOK_PART VALUES (107, 'CYBERSECURITY', 'PLANETA', 2015);
INSERT INTO BOOK_PART VALUES (108, 'OPERATING SYSTEM: A PRACTICAL APPROACH', 'PEARSON', 2015);
GO

SELECT PUB_YEAR, $PARTITION.PF_PUB_YEAR(PUB_YEAR) AS PARTITION_NUMBER FROM BOOK_PART GROUP BY PUB_YEAR;
GO

-- Q5 Create a view of all books and its number of copies that are currently available in the Library.
CREATE VIEW VIEW_BOOKS AS SELECT B.BOOK_ID, B.TITLE, C.NO_OF_COPIES 
FROM BOOK B, BOOK_COPIES C, LIBRARY_BRANCH L 
WHERE B.BOOK_ID=C.BOOK_ID AND C.BRANCH_ID=L.BRANCH_ID;
GO

SELECT * FROM VIEW_BOOKS;
GO

--------------END----------------
